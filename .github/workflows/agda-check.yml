name: Check Agda Files

on:
  schedule:
    # Runs twice a day at 08:00 and 18:00 BRT
    - cron: '0 11,21 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  check-all-agda: 
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment
        run: |
          echo "PATH=$PATH:/usr/local/bin:/home/runner/.local/bin" >> $GITHUB_ENV

      - name: Verify Agda and agda-cli installations
        run: |
          agda --version
          agda-cli --version

      - name: Run Agda checks
        id: check_agda
        run: | 
          search_path="./Base"
          OK_OUTPUT=$'Checked.\nNo output'
          errors_found=false
          output=""

          while IFS= read -r -d '' file
          do
            check_output=$(agda-cli check "$file" 2>&1)
            if [ "${check_output}" = "$OK_OUTPUT" ]; then
              echo "Checked $file: OK"
              output+="Checked $file: OK\n"
            else
              echo -e "\033[31mChecking: $file ERR\033[0m"
              echo "$check_output"
              output+="Checking: $file ERR\n$check_output\n"
              errors_found=true
            fi
          done < <(find "$search_path" -name "*.agda" -not -path "*.tmp*" -not -path "*/Test/*" -print0)

          echo "$output" > output.log
          echo "errors_found=$errors_found" >> $GITHUB_ENV
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          

      - name: Check if errors were found
        if: env.errors_found == 'true'
        run: |
          echo "Processing issue creation or update..."

      - name: Find existing issue
        id: find_existing_issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              });
            const existingIssue = issues.find(issue => 
              issue.title === "Agda Check Errors (Auto-generated)" && issue.user.login === github-actions[bot] && issue.labels.some(label => label.name === errors)
            );
            return existingIssue ? existingIssue.number : null;
          result-encoding: string
            
      - name: Create or update issue
        if: env.errors_found == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with: 
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.find_existing_issue.outputs.result || 'new'}}
          body: |
            # Agda Check Errors
            The following files failed checking:
            ```hs
            ${{ steps.check_agda.outputs.output }}
            ```
          title: "Agda Check Errors (Auto-generated)"
          labels: errors, automated
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Issue Number
        if: ${{ steps.find_existing_issue.outputs.result == '' && env.errors_found == 'true' }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = {{ steps.create_or_update_comment.outputs.issue_number }};
            fs.writeFileSync('.issue_number', issue_number);

      - name: Upload output as an artifact
        if: env.errors_found == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: agda-check-output
          path: output.log

      - name: Clean up
        run: rm output.log

